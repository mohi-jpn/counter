<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.7"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-colorschemes"></script>
    <script src="js/options.js"></script>

    <link rel="stylesheet" href="css/style.css">
    <title>カウンター</title>
</head>

<body>
    <div class="container">
        <header>
            <h1>カウンター</h1>
        </header>
        計測したタイミングを可視化できます
    </div>

    <div class="container">

        <div class="btn-toolbar justify-content-between" role="toolbar" aria-label="Toolbar with button groups">
            <div class="btn-group me-2" role="group" aria-label="First group">
              <button type="button" id="display" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#exampleModal">
                  グラフ表示
              </button>
            </div>
            <div class="btn-group me-2" role="group" aria-label="Second group">
              <button type="button" id="reset" class="btn btn-sm btn-outline-secondary">リセット</button>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">カウントタイミング</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">

              <div>
                <canvas id="myChart" style="-webkit-tap-highlight-color: transparent"></canvas>
              </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

        <div class="result">
            <p>スコア</p>
            <p id="score">0</p>
        </div>

        <button type="button" id="count" class="btn-circle-stitch">タップ</button>

    </div>

    <hr>

    <div class="container">
        <footer>
            <p>
                &copy; 2021 <a href="https://twitter.com/mohi_jpn" target="_blank">@mohi_jpn</a>
            </p>
        </footer>
    </div>

    <script>
        const MAX_HISTORY = 3;
        const ctx = document.getElementById("myChart");
        let history = [[]];
        let data = [];
        let myChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    pointRadius: 10,
                    data: data,
                }],
            },
            //import from js/options.js
            options: options,
        });

        document.getElementById('count').addEventListener('click', function () {
            const time = Date.now();

            document.getElementById('score').innerHTML++;
            history[0].push(time);
        });

        document.getElementById('reset').addEventListener('click', function () {
            history.unshift([]);
            document.getElementById('score').innerHTML = 0;
            if (history.length > MAX_HISTORY) history.length = MAX_HISTORY;
            data.length = 0;
            myChart.data.datasets[0].data = data;
            myChart.update();
        });

        document.getElementById('display').addEventListener('click', function () {
            let datasets = [];
            history.forEach((element, index) => {
                const start_time = element[0];
                data = element.map((time) => {
                    return {
                        x: (time - start_time) / 1000,
                        y: 0,
                    }
                });
                datasets.push({
                    label: convertLabel(index),
                    pointRadius: 10,
                    data: data,
                })
            });
            myChart.data.datasets = datasets;
            myChart.update();
        });

        const convertLabel = (num) => {
            if (num === 0){
                return '最新のやつ'
            } else {
                return `${num}つ前のやつ`
            }
        }

    </script>
</body>

</html>