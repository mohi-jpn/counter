<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.7"></script>

    <link rel="stylesheet" href="css/style.css">
    <title>カウンター</title>
</head>

<body>
    <div class="container">
        <header>
            <h1>カウンター</h1>
        </header>
        計測したタイミングを可視化できます
    </div>

    <div class="container">

        <div class="btn-toolbar justify-content-between" role="toolbar" aria-label="Toolbar with button groups">
            <div class="btn-group me-2" role="group" aria-label="First group">
              <button type="button" id="display" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#exampleModal">
                  グラフ表示
              </button>
            </div>
            <div class="btn-group me-2" role="group" aria-label="Second group">
              <button type="button" id="reset" class="btn btn-sm btn-outline-secondary">リセット</button>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">カウントタイミング</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">

              <div>
                <canvas id="myChart"></canvas>
              </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

        <div class="result">
            <p>スコア</p>
            <p id="score">0</p>
        </div>

        <div class="d-grid gap-2">
            <button type="button" id="count" class="btn btn-lg btn-primary">タップ</button>
        </div>
    </div>

    <hr>

    <div class="container">
        <footer>
            <p>
                &copy; 2021 <a href="https://twitter.com/mohi_jpn" target="_blank">@mohi_jpn</a>
            </p>
        </footer>
    </div>

    <script>
        const ctx = document.getElementById("myChart");
        let history = [];
        let data = [];
        const options = {
            title: {
                display: false,
            },
            legend: {
                display: false,
            },
            tooltips: {
                callbacks: {
                    label: (tooltipItem, data) => {
                        return `score: ${tooltipItem.index + 1}, time: ${tooltipItem.label}`;
                    },
                },
            },
            scales: {
                xAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: '時間(ミリ秒)',
                    },
                    gridLines: {
                        display: true,
                        color: '#ffffff',
                        zeroLineColor: '#ddd',
                        zeroLineWidth: 2,
                    },
                    ticks: {
                        fontColor: '#333',
                        min: 0,
                    },
                }],
                yAxes: [{
                    scaleLabel: {
                        display: false,
                    },
                    gridLines: {
                        color: '#ffffff',
                        zeroLineColor: '#ddd',
                        zeroLineWidth: 2,
                    },
                    ticks: {
                        display: false,
                        fontColor: '#333',
                        min: -5,
                        max: 5,
                    }
                }]
            },
            plugins: {
                zoom: {
                    pan: {
                        enabled: true,
                        mode: 'x'
                    },
                    zoom: {
                        enabled: true,
                        mode: 'x',
                        sensitivity: 3
                    }
                }
            }
        };
        let myChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    backgroundColor: 'rgba(255, 48, 32, 0.45)',
                    borderColor: 'rgba(255, 48, 32, 0.5)',
                    pointRadius: 10,
                    data: data,
                }],
            },
            options: options,
        });

        document.getElementById('count').addEventListener('click', function () {
            const time = Date.now();

            document.getElementById('score').innerHTML++;
            history.push(time);
        });

        document.getElementById('reset').addEventListener('click', function () {
            document.getElementById('score').innerHTML = 0;
            history.length = 0;
            data.length = 0;
            myChart.data.datasets[0].data = data;
            myChart.update();
        });

        document.getElementById('display').addEventListener('click', function () {
            const start_time = history[0];
            data = history.map((time) => {
                return {
                    x: time - start_time,
                    y: 0,
                }
            });
            myChart.data.datasets[0].data = data;
            myChart.update();
        });

    </script>
</body>

</html>